<!DOCTYPE html>
<html lang="en" dir="ltr">
<head><script src="/www6vKubernetes/livereload.js?mindelay=10&amp;v=2&amp;port=1313&amp;path=www6vKubernetes/livereload" data-no-instant defer></script>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="description" content="目录 # 使用kubebuilder构建Operator的过程 # 自己定义DaemonSet Operator包括： 在每个node上启动一个Pod（CRD &#43; Controller） webhook(证书 &#43; mutation &#43; validation) Step1: init project # Create a kubebuilder project, which requires an empty folder # kubebuilder init --domain cncamp.io Check project layout # cat PROJECT domain: cncamp.io layout: - go.kubebuilder.io/v3 projectName: mysts repo: github.com/www6v/demo-operator version: &#34;3&#34; Step2: Create CRD and Controller # Create API, create resource[Y], create controller[Y] # kubebuilder create api --group apps --version v1beta1 --kind MyDaemonset edit api/v1alpha1/simplestatefulset_types.">
<meta name="theme-color" media="(prefers-color-scheme: light)" content="#ffffff">
<meta name="theme-color" media="(prefers-color-scheme: dark)" content="#343a40">
<meta name="color-scheme" content="light dark"><meta property="og:url" content="http://localhost:1313/www6vKubernetes/ref/cloudNative/k8s-operator/">
  <meta property="og:site_name" content="Cloud Native">
  <meta property="og:title" content="Kubernetes Operator-kubebuilder">
  <meta property="og:description" content="目录 # 使用kubebuilder构建Operator的过程 # 自己定义DaemonSet Operator包括： 在每个node上启动一个Pod（CRD &#43; Controller） webhook(证书 &#43; mutation &#43; validation) Step1: init project # Create a kubebuilder project, which requires an empty folder # kubebuilder init --domain cncamp.io Check project layout # cat PROJECT domain: cncamp.io layout: - go.kubebuilder.io/v3 projectName: mysts repo: github.com/www6v/demo-operator version: &#34;3&#34; Step2: Create CRD and Controller # Create API, create resource[Y], create controller[Y] # kubebuilder create api --group apps --version v1beta1 --kind MyDaemonset edit api/v1alpha1/simplestatefulset_types.">
  <meta property="og:locale" content="en">
  <meta property="og:type" content="article">
    <meta property="article:section" content="ref">
    <meta property="article:published_time" content="2021-12-30T20:42:36+00:00">
    <meta property="article:modified_time" content="2021-12-30T20:42:36+00:00">
    <meta property="article:tag" content="Kubernetes">
<title>Kubernetes Operator-kubebuilder | Cloud Native</title>
<link rel="icon" href="/www6vKubernetes/favicon.png" >
<link rel="manifest" href="/www6vKubernetes/manifest.json">
<link rel="canonical" href="http://localhost:1313/www6vKubernetes/ref/cloudNative/k8s-operator/">
<link rel="stylesheet" href="/www6vKubernetes/book.min.6c8b9d2a1fc95075ed7da46ca81060b39add8fff6741ac51259f768929281e2c.css" integrity="sha256-bIudKh/JUHXtfaRsqBBgs5rdj/9nQaxRJZ92iSkoHiw=" crossorigin="anonymous">
  <script defer src="/www6vKubernetes/fuse.min.js"></script>
  <script defer src="/www6vKubernetes/en.search.min.d2a919048d8b73cb72750d28ea6985ef9731ebdb275275aa436109a17bd7abb8.js" integrity="sha256-0qkZBI2Lc8tydQ0o6mmF75cx69snUnWqQ2EJoXvXq7g=" crossorigin="anonymous"></script>

  

<!--
Made with Book Theme
https://github.com/alex-shpak/hugo-book
-->
  
</head>
<body dir="ltr">
  <input type="checkbox" class="hidden toggle" id="menu-control" />
  <input type="checkbox" class="hidden toggle" id="toc-control" />
  <main class="container flex">
    <aside class="book-menu">
      <div class="book-menu-content">
        
  <nav>
<h2 class="book-brand">
  <a class="flex align-center" href="/www6vKubernetes/"><span>Cloud Native</span>
  </a>
</h2>


<div class="book-search hidden">
  <input type="text" id="book-search-input" placeholder="Search" aria-label="Search" maxlength="64" data-hotkeys="s/" />
  <div class="book-search-spinner hidden"></div>
  <ul id="book-search-results"></ul>
</div>
<script>document.querySelector(".book-search").classList.remove("hidden")</script>















  
  <ul>
    
      
        <li>
          
  
  

  
    <span>编排原理</span>
  

          
  <ul>
    
      
        <li>
          
  
  

  
    <a href="/www6vKubernetes/docs/orchestrate/k8sDeployment/" class="">Kubernetes Deployment</a>
  

          
  <ul>
    
  </ul>

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/www6vKubernetes/docs/orchestrate/k8sResource/" class="">Kubernetes Workload</a>
  

          
  <ul>
    
  </ul>

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/www6vKubernetes/docs/orchestrate/k8sStatefulSet/" class="">Kubernetes StatefulSet原理和源码</a>
  

          
  <ul>
    
  </ul>

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/www6vKubernetes/docs/orchestrate/k8sResouceModel/" class="">Kubenetes资源模型</a>
  

          
  <ul>
    
  </ul>

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/www6vKubernetes/docs/orchestrate/k8sPLEG/" class="">kubelet和PLEG</a>
  

          
  <ul>
    
  </ul>

        </li>
      
    
  </ul>

        </li>
      
    
  </ul>














</nav>




  <script>(function(){var e=document.querySelector("aside .book-menu-content");addEventListener("beforeunload",function(){localStorage.setItem("menu.scrollTop",e.scrollTop)}),e.scrollTop=localStorage.getItem("menu.scrollTop")})()</script>


 
      </div>
    </aside>

    <div class="book-page">
      <header class="book-header">
        
  <div class="flex align-center justify-between">
  <label for="menu-control">
    <img src="/www6vKubernetes/svg/menu.svg" class="book-icon" alt="Menu" />
  </label>

  <h3>Kubernetes Operator-kubebuilder</h3>

  <label for="toc-control">
    
    <img src="/www6vKubernetes/svg/toc.svg" class="book-icon" alt="Table of Contents" />
    
  </label>
</div>


  
  <aside class="hidden clearfix">
    
  
<nav id="TableOfContents">
  <ul>
    <li>
      <ul>
        <li><a href="#目录">目录</a></li>
        <li><a href="#使用kubebuilder构建operator的过程">使用kubebuilder构建Operator的过程</a></li>
        <li><a href="#step1--init-project">Step1:  init project</a>
          <ul>
            <li></li>
          </ul>
        </li>
        <li><a href="#step2-create--crd-and-controller">Step2: Create  CRD and Controller</a>
          <ul>
            <li></li>
          </ul>
        </li>
        <li><a href="#step3-enable-webhooks">Step3: Enable webhooks</a>
          <ul>
            <li></li>
          </ul>
        </li>
        <li><a href="#附件-operator源代码">附件: Operator源代码</a></li>
      </ul>
    </li>
  </ul>
</nav>



  </aside>
  
 
      </header>

      
      
  <article class="markdown book-article"><p></p>
<!-- more -->
<h2 id="目录">
  目录
  <a class="anchor" href="#%e7%9b%ae%e5%bd%95">#</a>
</h2>
<!-- toc -->
<h2 id="使用kubebuilder构建operator的过程">
  使用kubebuilder构建Operator的过程
  <a class="anchor" href="#%e4%bd%bf%e7%94%a8kubebuilder%e6%9e%84%e5%bb%baoperator%e7%9a%84%e8%bf%87%e7%a8%8b">#</a>
</h2>
<ul>
<li>自己定义DaemonSet Operator包括：
<ul>
<li><a href="#step2-create-crd-and-controller">在每个node上启动一个Pod（CRD + Controller）</a></li>
<li><a href="#step3-enable-webhooks">webhook(证书 + mutation + validation)</a></li>
</ul>
</li>
</ul>
<h2 id="step1--init-project">
  Step1:  init project
  <a class="anchor" href="#step1--init-project">#</a>
</h2>
<h5 id="create-a-kubebuilder-project-which-requires-an-empty-folder">
  Create a kubebuilder project, which requires an empty folder
  <a class="anchor" href="#create-a-kubebuilder-project-which-requires-an-empty-folder">#</a>
</h5>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>kubebuilder init --domain cncamp.io
</span></span></code></pre></div><h5 id="check-project-layout">
  Check project layout
  <a class="anchor" href="#check-project-layout">#</a>
</h5>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>cat PROJECT
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>domain: cncamp.io
</span></span><span style="display:flex;"><span>layout:
</span></span><span style="display:flex;"><span>- go.kubebuilder.io/v3
</span></span><span style="display:flex;"><span>projectName: mysts
</span></span><span style="display:flex;"><span>repo: github.com/www6v/demo-operator
</span></span><span style="display:flex;"><span>version: <span style="color:#e6db74">&#34;3&#34;</span>
</span></span></code></pre></div><h2 id="step2-create--crd-and-controller">
  Step2: Create  CRD and Controller
  <a class="anchor" href="#step2-create--crd-and-controller">#</a>
</h2>
<h5 id="create-api-create-resourcey-create-controllery">
  Create API, create resource[Y], create controller[Y]
  <a class="anchor" href="#create-api-create-resourcey-create-controllery">#</a>
</h5>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>kubebuilder create api --group apps --version v1beta1 --kind MyDaemonset
</span></span></code></pre></div><h5 id="edit-apiv1alpha1simplestatefulset_typesgo">
  edit <code>api/v1alpha1/simplestatefulset_types.go</code>
  <a class="anchor" href="#edit-apiv1alpha1simplestatefulset_typesgo">#</a>
</h5>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>// MyDaemonsetSpec defines the desired state of MyDaemonset
</span></span><span style="display:flex;"><span>type MyDaemonsetSpec struct <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>	// INSERT ADDITIONAL SPEC FIELDS - desired state of cluster
</span></span><span style="display:flex;"><span>	// Important: Run <span style="color:#e6db74">&#34;make&#34;</span> to regenerate code after modifying this file
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	// Foo is an example field of MyDaemonset. Edit mydaemonset_types.go to remove/update
</span></span><span style="display:flex;"><span>	Image string <span style="color:#e6db74">`</span>json:<span style="color:#e6db74">&#34;image,omitempty&#34;</span><span style="color:#e6db74">`</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>// MyDaemonsetStatus defines the observed state of MyDaemonset
</span></span><span style="display:flex;"><span>type MyDaemonsetStatus struct <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>	AvaiableReplicas int <span style="color:#e6db74">`</span>json:<span style="color:#e6db74">&#34;avaiableReplicas,omitempty&#34;</span><span style="color:#e6db74">`</span>
</span></span><span style="display:flex;"><span>	// INSERT ADDITIONAL STATUS FIELD - define observed state of cluster
</span></span><span style="display:flex;"><span>	// Important: Run <span style="color:#e6db74">&#34;make&#34;</span> to regenerate code after modifying this file
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span></code></pre></div><h5 id="check-makefile">
  Check Makefile
  <a class="anchor" href="#check-makefile">#</a>
</h5>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-makefile" data-lang="makefile"><span style="display:flex;"><span><span style="color:#a6e22e">Build targets</span><span style="color:#f92672">:</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">### create code skeletion</span>
</span></span><span style="display:flex;"><span>    manifests: generate crd
</span></span><span style="display:flex;"><span>    generate: generate api functions, like deepCopy
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">### generate crd and install</span>
</span></span><span style="display:flex;"><span>    run: Run a controller from your host.
</span></span><span style="display:flex;"><span>    install: Install CRDs into the K8s cluster specified in ~/.kube/config.
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">### docker build and deploy</span>
</span></span><span style="display:flex;"><span>    docker-build: Build docker image with the manager.
</span></span><span style="display:flex;"><span>    docker-push: Push docker image with the manager.
</span></span><span style="display:flex;"><span>    deploy: Deploy controller to the K8s cluster specified in ~/.kube/config.
</span></span></code></pre></div><h5 id="edit-controllersmydaemonset_controllergo-add-permissions-to-the-controller">
  Edit <code>controllers/mydaemonset_controller.go</code>, add permissions to the controller
  <a class="anchor" href="#edit-controllersmydaemonset_controllergo-add-permissions-to-the-controller">#</a>
</h5>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#75715e">//+kubebuilder:rbac:groups=apps.cncamp.io,resources=mydaemonsets/finalizers,verbs=update
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">// Add the following
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">//+kubebuilder:rbac:groups=core,resources=nodes,verbs=get;list;watch
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">//+kubebuilder:rbac:groups=core,resources=pods,verbs=get;list;watch;create;update;patch;delete
</span></span></span></code></pre></div><h5 id="generate-crd">
  Generate crd
  <a class="anchor" href="#generate-crd">#</a>
</h5>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>make manifests
</span></span></code></pre></div><h5 id="build--install">
  Build &amp; install
  <a class="anchor" href="#build--install">#</a>
</h5>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>make build
</span></span><span style="display:flex;"><span>make docker-build
</span></span><span style="display:flex;"><span>make docker-push
</span></span><span style="display:flex;"><span>make deploy
</span></span></code></pre></div><h2 id="step3-enable-webhooks">
  Step3: Enable webhooks
  <a class="anchor" href="#step3-enable-webhooks">#</a>
</h2>
<h5 id="install-cert-manager">
  Install cert-manager
  <a class="anchor" href="#install-cert-manager">#</a>
</h5>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>kubectl apply -f https://github.com/jetstack/cert-manager/releases/download/v1.6.1/cert-manager.yaml
</span></span></code></pre></div><h5 id="create-webhooks">
  Create webhooks
  <a class="anchor" href="#create-webhooks">#</a>
</h5>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>kubebuilder create webhook --group apps --version v1beta1 --kind MyDaemonset --defaulting --programmatic-validation
</span></span></code></pre></div><h5 id="change-code">
  Change code
  <a class="anchor" href="#change-code">#</a>
</h5>
<h5 id="enable-webhook-in-configdefaultkustomizationyaml">
  Enable webhook in <code>config/default/kustomization.yaml</code>
  <a class="anchor" href="#enable-webhook-in-configdefaultkustomizationyaml">#</a>
</h5>
<h5 id="redeploy">
  Redeploy
  <a class="anchor" href="#redeploy">#</a>
</h5>
<h2 id="附件-operator源代码">
  附件: Operator源代码
  <a class="anchor" href="#%e9%99%84%e4%bb%b6-operator%e6%ba%90%e4%bb%a3%e7%a0%81">#</a>
</h2>
<p><a href="https://github.com/www6v/mydaemonset">https://github.com/www6v/mydaemonset</a></p>
</article>
 
      

      <footer class="book-footer">
        
  <div class="flex flex-wrap justify-between">





</div>



  <script>(function(){function e(e){const t=window.getSelection(),n=document.createRange();n.selectNodeContents(e),t.removeAllRanges(),t.addRange(n)}document.querySelectorAll("pre code").forEach(t=>{t.addEventListener("click",function(){if(window.getSelection().toString())return;e(t.parentElement),navigator.clipboard&&navigator.clipboard.writeText(t.parentElement.textContent)})})})()</script>


 
        
      </footer>

      
  
  <div class="book-comments">

</div>
  
 

      <label for="menu-control" class="hidden book-menu-overlay"></label>
    </div>

    
    <aside class="book-toc">
      <div class="book-toc-content">
        
  
<nav id="TableOfContents">
  <ul>
    <li>
      <ul>
        <li><a href="#目录">目录</a></li>
        <li><a href="#使用kubebuilder构建operator的过程">使用kubebuilder构建Operator的过程</a></li>
        <li><a href="#step1--init-project">Step1:  init project</a>
          <ul>
            <li></li>
          </ul>
        </li>
        <li><a href="#step2-create--crd-and-controller">Step2: Create  CRD and Controller</a>
          <ul>
            <li></li>
          </ul>
        </li>
        <li><a href="#step3-enable-webhooks">Step3: Enable webhooks</a>
          <ul>
            <li></li>
          </ul>
        </li>
        <li><a href="#附件-operator源代码">附件: Operator源代码</a></li>
      </ul>
    </li>
  </ul>
</nav>


 
      </div>
    </aside>
    
  </main>

  
</body>
</html>












